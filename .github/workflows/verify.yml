name: Verify Worker

on:
  workflow_dispatch:
    inputs:
      url:
        required: true
      uid:
        required: true

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install deps
      run: |
        pip install requests beautifulsoup4 lxml

    - name: Run runner
      run: |
        python3 runner.py "${{ github.event.inputs.url }}" > out.txt 2>&1 || true

    - name: Detect result
      run: |
        if grep -q FINAL_SUCCESS out.txt; then echo SUCCESS > result_${{ github.event.inputs.uid }}.txt
        elif grep -q FINAL_PENDING out.txt; then echo PENDING > result_${{ github.event.inputs.uid }}.txt
        elif grep -q FINAL_FRAUD out.txt; then echo FRAUD > result_${{ github.event.inputs.uid }}.txt
        else echo FAILED > result_${{ github.event.inputs.uid }}.txt
        fi

    - name: Push result
      run: |
        git config user.name bot
        git config user.email bot@bot.com
        git add .
        git commit -m "result" || true
        git push
